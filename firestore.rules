rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuth() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    function getUserData(userId) {
        return get(/databases/$(database)/documents/users/$(userId)).data
    }

    function hasRole(role) {
      return role in getUserData(request.auth.uid).roles;
    }

    function isMasterAdmin() {
      return isAuth() && hasRole('master-admin');
    }

    function isAdmin() {
      return isAuth() && (hasRole('admin') || hasRole('master-admin'));
    }

    function isCoach() {
      return isAuth() && (hasRole('coach') || isAdmin());
    }

    function isSponsor() {
      return isAuth() && hasRole('sponsor');
    }

    // PUBLIC COLLECTIONS
    match /news/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /players/{docId} {
      allow read: if true;
      allow write: if isCoach();
    }

    match /teams/{docId} {
      allow read: if true;
      allow write: if isCoach();
    }

    match /seasons/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /games/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // USER DATA
    match /users/{userId} {
      allow read: if isAuth();
      allow create;
      allow update: if isUser(userId) || isMasterAdmin();
      allow delete: if isMasterAdmin();
    }

    // PENDING USERS (for sponsor signup, contact-based user creation)
    match /pendingUsers/{docId} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // TRYOUTS
    match /tryout-applicants/{applicantId} {
      allow read: if isCoach();
      allow create: if true;
      allow update: if isCoach();

      match /evaluations/{evaluationId} {
        allow read, write: if isCoach();
      }
    }

    // COMMUNICATIONS
    match /communications/{messageId} {
      allow create: if isAdmin();
      allow read: if isAuth() && request.auth.uid in resource.data.recipients;
      allow write: if false;
    }

    // SPONSORS
    match /sponsors/{docId} {
      allow read: if true;
      allow create: if true;
      allow update: if isAdmin() || (isSponsor() && resource.data.userId == request.auth.uid);
      allow delete: if isAdmin();
    }

    // SCHEDULES / EVENTS
    match /schedules/{docId} {
      allow read: if true;
      allow write: if isCoach();
    }

    // ANNOUNCEMENTS
    match /announcements/{docId} {
      allow read: if isAuth();
      allow write: if isCoach();
    }

    // CONVERSATIONS & MESSAGES
    match /conversations/{convoId} {
      allow read: if isAuth() && request.auth.uid in resource.data.participantIds;
      allow create: if isAuth();
      allow update: if isAuth() && request.auth.uid in resource.data.participantIds;

      match /messages/{messageId} {
        allow read, create: if isAuth();
      }
    }

    // DOCUMENTS (role-based visibility)
    match /documents/{docId} {
      allow read: if isAuth() && (
        isAdmin() ||
        (isCoach() && resource.data.visibility in ['public', 'parent', 'coach', 'team']) ||
        (hasRole('parent') && resource.data.visibility in ['public', 'parent']) ||
        resource.data.visibility == 'public'
      );
      allow write: if isCoach();
    }

    // MEDIA
    match /media/{docId} {
      allow read: if isAuth();
      allow write: if isCoach();
    }

    // TOURNAMENTS
    match /tournaments/{docId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // VOLUNTEERS
    match /volunteers/{docId} {
      allow read: if isAuth();
      allow write: if isCoach();
    }

    // FUNDRAISERS
    match /fundraisers/{docId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // PLAYER FINANCES
    match /playerFinances/{docId} {
      allow read: if isCoach();
      allow write: if isAdmin();
    }

    // EXPENSES
    match /expenses/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // INCOME
    match /income/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // COST ASSUMPTIONS
    match /costs/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // BUDGETS
    match /budgets/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ACCOUNTS
    match /accounts/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // VENDORS
    match /vendors/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // PLAYER METRICS
    match /playerMetrics/{docId} {
      allow read: if isCoach();
      allow write: if isCoach();
    }

    // SCHOLARSHIPS
    match /scholarships/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // EQUIPMENT
    match /equipment/{docId} {
      allow read: if isCoach();
      allow write: if isAdmin();
    }

    // INVOICE TOKENS (QR code payments)
    match /invoiceTokens/{docId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if true;
      allow delete: if isAdmin();
    }

    // MAIL (receipt emails via Firebase Trigger Email extension)
    match /mail/{docId} {
      allow create: if isAuth();
      allow read: if isAdmin();
    }

    // RECEIPTS (fallback receipt storage)
    match /receipts/{docId} {
      allow create: if isAuth();
      allow read: if isAdmin();
    }

    // CONTACT FORM SUBMISSIONS
    match /contactSubmissions/{docId} {
      allow read: if isAdmin();
      allow create: if true;
    }

    // HOMEPAGE POSTS (public-facing content)
    match /homepagePosts/{docId} {
      allow read: if true;
      allow create: if isCoach();
      allow update: if isCoach();
      allow delete: if isAdmin();
    }

    // GAMECHANGER DATA
    match /gcStats/{docId} {
      allow read: if isCoach();
      allow write: if isAdmin();
    }

    match /gcGames/{docId} {
      allow read: if isCoach();
      allow write: if isAdmin();
    }
  }
}
