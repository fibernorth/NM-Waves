rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions
    function isAuth() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    function getUserData(userId) {
        return get(/databases/$(database)/documents/users/$(userId)).data
    }

    function isMasterAdmin() {
      return isAuth() && getUserData(request.auth.uid).role == 'master-admin';
    }

    function isAdmin() {
      let userRole = getUserData(request.auth.uid).role;
      return isAuth() && (userRole == 'admin' || userRole == 'master-admin');
    }
    
     function isCoach() {
      let userRole = getUserData(request.auth.uid).role;
      return isAuth() && (userRole == 'coach' || isAdmin());
    }

    // PUBLIC COLLECTIONS
    match /news/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /players/{docId} {
        allow read: if true;
        allow write: if isAdmin();
    }
    
    match /teams/{docId} {
        allow read: if true;
        allow write: if isAdmin();
    }
    
    match /seasons/{docId} {
        allow read: if true;
        allow write: if isAdmin();
    }
    
    match /games/{docId} {
        allow read: if true;
        allow write: if isAdmin();
    }

    // USER DATA
    match /users/{userId} {
      allow read: if isUser(userId) || isAdmin();
      allow create; // Allow user creation
      allow update: if isUser(userId) || isMasterAdmin(); // Only user or master admin can update
      allow delete: if isMasterAdmin();
    }

    // TRYOUTS
    match /tryout-applicants/{applicantId} {
      allow read: if isCoach(); // Coaches/Admins can see all applicants
      allow create: if true; // Public can register
      allow update: if isCoach(); // Coaches/Admins can update (e.g., assign to team)
      
      // EVALUATIONS
       match /evaluations/{evaluationId} {
         allow read, write: if isCoach();
       }
    }
    
    // COMMUNICATIONS
    match /communications/{messageId} {
        allow create: if isAdmin();
        // Allow read only if the user's ID is in the recipients list
        allow read: if isAuth() && request.auth.uid in resource.data.recipients;
        allow write: if false; // Messages are immutable
    }

    // SPONSORS
    match /sponsors/{docId} {
      allow read: if true; // Public can view sponsors
      allow write: if isAdmin();
    }

    // SCHEDULES / EVENTS
    match /schedules/{docId} {
      allow read: if true; // Public can view schedule
      allow write: if isCoach();
    }

    // ANNOUNCEMENTS
    match /announcements/{docId} {
      allow read: if isAuth();
      allow write: if isCoach();
    }

    // CONVERSATIONS & MESSAGES
    match /conversations/{convoId} {
      allow read: if isAuth() && request.auth.uid in resource.data.participantIds;
      allow create: if isAuth();
      allow update: if isAuth() && request.auth.uid in resource.data.participantIds;

      match /messages/{messageId} {
        allow read, create: if isAuth();
      }
    }

    // DOCUMENTS (role-based visibility)
    match /documents/{docId} {
      allow read: if isAuth() && (
        // Admins see all
        isAdmin() ||
        // Coaches see public, parent, coach, team docs
        (isCoach() && resource.data.visibility in ['public', 'parent', 'coach', 'team']) ||
        // Parents see public and parent docs
        (getUserData(request.auth.uid).role == 'parent' && resource.data.visibility in ['public', 'parent']) ||
        // Any authenticated user can see public docs
        resource.data.visibility == 'public'
      );
      allow write: if isCoach();
    }

    // MEDIA
    match /media/{docId} {
      allow read: if isAuth();
      allow write: if isCoach();
    }

    // TOURNAMENTS
    match /tournaments/{docId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // VOLUNTEERS
    match /volunteers/{docId} {
      allow read: if isAuth();
      allow write: if isCoach();
    }

    // FUNDRAISERS
    match /fundraisers/{docId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // PLAYER FINANCES
    match /playerFinances/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // EXPENSES
    match /expenses/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // INCOME
    match /income/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // COST ASSUMPTIONS (collection name: "costs" in app)
    match /costs/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // BUDGETS
    match /budgets/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ACCOUNTS
    match /accounts/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // VENDORS
    match /vendors/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // PLAYER METRICS (collection name: "playerMetrics" in app)
    match /playerMetrics/{docId} {
      allow read: if isCoach();
      allow write: if isCoach();
    }

    // SCHOLARSHIPS
    match /scholarships/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // EQUIPMENT
    match /equipment/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // CONTACT FORM SUBMISSIONS
    match /contactSubmissions/{docId} {
      allow read: if isAdmin();
      allow create: if true; // Public can submit contact forms
    }
  }
}
